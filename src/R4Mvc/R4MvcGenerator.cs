using System.Linq;

using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Microsoft.CodeAnalysis.CSharp.Syntax;

namespace R4Mvc
{
	public static class R4MvcGenerator
	{
		private const string _headerText = @"
// <auto-generated />
// This file was generated by a R4Mvc.
// Don't change it directly as your change would get overwritten.  Instead, make changes
// to the r4mvc.json file (i.e. the settings file), save it and rebuild.

// Make sure the compiler doesn't complain about missing Xml comments and CLS compliance
// 0108: suppress ""Foo hides inherited member Foo.Use the new keyword if hiding was intended."" when a controller and its abstract parent are both processed";

		public static SyntaxNode Generate(CSharpCompilation compiler, ClassDeclarationSyntax[] mvcControllerNodes)
		{
			// Grab the first controller node and model and symbol for grabbing the root controller namespace
			var firstNode = mvcControllerNodes.First();
			var firstModel = compiler.GetSemanticModel(firstNode.SyntaxTree);
			var firstSymbol = firstModel.GetDeclaredSymbol(firstNode);

			// Create the root node and add header, pragma, usings
			var fileTree = SyntaxHelpers.CreateNamespace(firstSymbol.ContainingNamespace.ToString());
			fileTree = fileTree.WithHeader(_headerText);
			fileTree = fileTree.WithPragmaCodes(false, 1591, 3008, 3009, 0108);
			fileTree = fileTree.WithUsings("System.CodeDom.Compiler");
			
			// loop through the controllers and create a partial node for each
			foreach (var mvcControllerNode in mvcControllerNodes)
			{
				var model = compiler.GetSemanticModel(mvcControllerNode.SyntaxTree);
				var mvcSymbol = model.GetDeclaredSymbol(mvcControllerNode);

				// create controller partial class node
				fileTree = fileTree.WithClass(mvcSymbol.Name, mvcControllerNode.TypeParameterList?.Parameters.ToArray());

				// TODO figure out nice method to fluently add attributes and subclasses
				// TODO create ActionNames sub class
				// TODO create ActionConstants sub class
				// TODO create T4MVC_[Controller] class inheriting from partial
			}

			// TODO create static MVC class
			// TODO create static Links class (scripts, content, bundles?)
			// TODO create R4MVCHelpers class

			// reenable pragma codes after last node
			fileTree = fileTree.WithPragmaCodes(true, 1591, 3008, 3009, 0108);
			return fileTree;
		}
		
		
	}
}